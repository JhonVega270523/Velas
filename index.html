<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Pedidos - Detalles Laurel Medellín</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c5530;
            --secondary: #d4af37;
            --accent: #8b4513;
            --light: #f5f5dc;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --text: #333333;
            --background: #f9f9f9;
            --info: #2196f3;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), #1e3a23);
            color: white;
            padding: 40px 0;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none"><path d="M0,0 L100,0 L100,100 Z" fill="rgba(212,175,55,0.1)"/></svg>');
            background-size: cover;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            position: relative;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
            position: relative;
            font-weight: 300;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
        }
        
        .card-title {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--secondary);
            position: relative;
        }
        
        .card-title::after {
            content: "";
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 50px;
            height: 2px;
            background-color: var(--accent);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary);
        }
        
        select, input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            background-color: #f9f9f9;
        }
        
        select:focus, input:focus, textarea:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
            background-color: white;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input {
            width: auto;
        }
        
        .checkbox-group label {
            margin-bottom: 0;
        }
        
        .btn {
            background-color: var(--secondary);
            color: var(--primary);
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            gap: 8px;
        }
        
        .btn:hover {
            background-color: #c19b2a;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #43a047;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #f57c00;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #e53935;
        }
        
        .btn-info {
            background-color: var(--info);
            color: white;
        }
        
        .btn-info:hover {
            background-color: #1976d2;
        }
        
        .btn-block {
            display: block;
            width: 100%;
            text-align: center;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        .btn-xs {
            padding: 6px 10px;
            font-size: 0.8rem;
        }
        
        .hidden {
            display: none;
        }
        
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -15px;
        }
        
        .col {
            flex: 1;
            padding: 0 15px;
            min-width: 300px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 25px;
            color: var(--primary);
            font-size: 0.9rem;
            border-top: 1px solid #e0e0e0;
        }
        
        /* Navegación */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
        }
        
        .nav-tab {
            flex: 1;
            text-align: center;
            padding: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: var(--primary);
            border-bottom: 3px solid transparent;
        }
        
        .nav-tab:hover {
            background: #f5f5f5;
            color: var(--accent);
        }
        
        .nav-tab.active {
            background: var(--primary);
            color: white;
            border-bottom: 3px solid var(--secondary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Productos - Diseño Simplificado */
        .products-section {
            margin-bottom: 25px;
        }
        
        .product-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            position: relative;
        }
        
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .product-number {
            font-weight: 600;
            color: var(--primary);
            font-size: 1rem;
        }
        
        .remove-product {
            background: transparent;
            color: #6c757d;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .remove-product:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        .product-fields {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            align-items: end;
        }
        
        .quantity-input {
            width: 100%;
        }
        
        .add-product-btn {
            background: transparent;
            color: var(--primary);
            border: 2px dashed var(--secondary);
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .add-product-btn:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: var(--primary);
        }
        
        /* Bases de Madera - Diseño Mejorado */
        .wood-bases-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #e9ecef;
        }
        
        .wood-bases-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 0;
            padding: 10px;
            border-radius: 6px;
            transition: background-color 0.3s;
        }
        
        .wood-bases-header:hover {
            background: rgba(0, 0, 0, 0.02);
        }
        
        .wood-bases-header input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .wood-bases-header label {
            margin-bottom: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
            cursor: pointer;
            flex: 1;
        }
        
        .wood-bases-content {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }
        
        .wood-bases-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 20px;
            align-items: start;
        }
        
        .wood-base-price {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            text-align: center;
        }
        
        .wood-base-price .price {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--accent);
            display: block;
            margin-bottom: 5px;
        }
        
        .wood-base-price .label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .wood-base-fields {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .wood-base-quantity {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .wood-base-quantity label {
            margin-bottom: 0;
            min-width: 100px;
        }
        
        .wood-base-quantity input {
            width: 100px;
        }
        
        /* Resumen */
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .summary-total {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #ddd;
        }
        
        .price {
            font-weight: bold;
            color: var(--accent);
        }
        
        /* Galería de imágenes de velas */
        .candle-gallery {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .candle-gallery-item {
            flex: 1;
            min-width: 150px;
            text-align: center;
        }
        
        .candle-gallery-image {
            width: 100%;
            height: 120px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid var(--secondary);
            margin-bottom: 8px;
        }
        
        .candle-gallery-label {
            font-size: 0.9rem;
            color: var(--primary);
            font-weight: 600;
        }
        
        /* Tabla de precios unificada */
        .unified-price-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .unified-price-table th, .unified-price-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .unified-price-table th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
        }
        
        .unified-price-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .price-section {
            background-color: rgba(44, 85, 48, 0.1);
            font-weight: 600;
            color: var(--primary);
        }
        
        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Línea contador para textarea */
        .line-counter {
            font-size: 0.8rem;
            color: #666;
            text-align: right;
            margin-top: 5px;
        }
        
        .line-counter.warning {
            color: var(--warning);
        }
        
        .line-counter.error {
            color: var(--danger);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header {
                padding: 20px 0;
                margin-bottom: 20px;
            }
            
            h1 {
                font-size: 1.8rem;
                margin-bottom: 10px;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            .nav-tabs {
                flex-direction: row;
            }
            
            .nav-tab {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .col {
                flex: 100%;
                padding: 0 10px;
            }
            
            .card {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .card-title {
                font-size: 1.3rem;
            }
            
            .candle-gallery {
                flex-direction: column;
                gap: 10px;
            }
            
            .candle-gallery-item {
                min-width: 100%;
            }
            
            .candle-gallery-image {
                height: 150px;
            }
            
            .product-fields {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .wood-bases-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .wood-base-quantity {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .wood-base-quantity input {
                width: 100%;
            }
            /* Responsive adjustments for history table, modal and filters */
            .filters-row {
                flex-direction: column;
                align-items: stretch;
            }

            .filters-row input,
            .filters-row button {
                width: 100% !important;
                max-width: none !important;
            }

            .unified-price-table th, .unified-price-table td {
                padding: 10px 8px;
                font-size: 0.95rem;
            }

            .unified-price-table td .btn {
                display: inline-block;
                margin: 6px 6px 0 0;
            }

            .btn-xs, .btn-sm {
                padding: 6px 8px;
                font-size: 0.85rem;
            }

            #orderDetailsModal > div {
                width: calc(100% - 28px);
                max-width: 720px;
                padding: 14px;
            }
        }

        @media (max-width: 768px) {
            .unified-price-table th, .unified-price-table td {
                padding: 10px 12px;
                font-size: 0.95rem;
            }

            .filters-row {
                flex-wrap: wrap;
            }

            .filters-row input[type="date"] {
                max-width: 160px;
            }

            .product-item {
                padding: 12px;
            }

            .product-number {
                font-size: 0.95rem;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
            }
            
            .nav-tab {
                padding: 10px 8px;
                font-size: 0.8rem;
            }
            
            header {
                padding: 15px 0;
            }
            /* Mobile tweaks requested: center specific card titles and ensure inputs show readable text */
            #prices-tab .card-title,
            #history-tab .card-title {
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                margin: 0 auto 8px auto;
                width: 100%;
            }

            /* Center the three nav tab labels vertically and horizontally */
            .nav-tabs {
                align-items: center;
            }
            .nav-tab {
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
                padding-top: 12px;
                padding-bottom: 12px;
                min-height: 72px;
                white-space: normal;
            }

            /* Ensure date inputs and other form controls show readable text on mobile */
            input[type="date"],
            input[type="text"],
            input[type="tel"],
            input[type="number"],
            select,
            textarea {
                color: #222;
                -webkit-text-fill-color: #222; /* iOS/Safari */
                box-sizing: border-box;
            }

            /* Small helper text to indicate expected date format: show only on small screens */
                .date-hint { display: none; }

            /* Prevent horizontal scrolling in the order tab */
            #order-tab {
                overflow-x: hidden;
            }
            #order-tab .card,
            #order-tab .products-section,
            #order-tab .wood-bases-section {
                overflow-x: hidden;
                max-width: 100%;
            }
            .product-item { min-width: 0; }
        }
        /* Toaster notifications */
        #toastContainer {
            position: fixed;
            right: 18px;
            top: 18px;
            z-index: 11000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
            pointer-events: none;
        }

        .toast {
            min-width: 220px;
            max-width: 360px;
            background: #fff;
            color: #222;
            padding: 12px 14px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            border-left: 4px solid var(--primary);
            opacity: 0;
            transform: translateY(-8px) scale(0.98);
            transition: all 220ms ease;
            pointer-events: auto;
            font-size: 0.95rem;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.info { border-left-color: var(--accent); }

        .toast small { display:block; color:#666; margin-top:6px; font-size:0.85rem; }

        /* Confirm modal (simple) */
        #confirmModal {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.45);
            align-items: center;
            justify-content: center;
            z-index: 12000;
            display: none;
        }

        /* Estado del pedido: botón sutil */
        .status-btn {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.08);
            font-weight: 600;
            cursor: pointer;
            min-width: 92px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }
        .status-pendiente {
            background: #fff5f5;
            color: #c0392b;
            border-color: rgba(192,57,43,0.12);
        }
        .status-entregado {
            background: #f3fff4;
            color: #1e8f3e;
            border-color: rgba(30,143,62,0.12);
        }

        /* Paginación simple */
        .pagination-btn {
            display:inline-flex;
            align-items:center;
            justify-content:center;
            min-width:36px;
            height:36px;
            padding:6px 10px;
            border-radius:6px;
            border:1px solid #e0e0e0;
            background:#fff;
            cursor:pointer;
            font-weight:600;
            color:var(--primary);
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }
        .pagination-btn:hover { background: #f5f5f5; }
        .pagination-btn.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }
        .pagination-info { color:#666; font-size:0.95rem; margin-left:8px; }

        #confirmModal > div {
            background: #fff;
            border-radius: 8px;
            max-width: 520px;
            width: 92%;
            padding: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.18);
        }

        /* Totales del historial */
        .history-totals {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .total-item {
            text-align: center;
            flex: 1;
        }

        .total-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--accent);
        }

        .total-label {
            font-size: 0.9rem;
            color: #666;
        }

        /* Botones de exportación/importación */
        .excel-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .excel-buttons .btn {
            flex: 1;
        }

        /* Input de archivo oculto */
        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Gestor de Pedidos - Detalles Laurel Medellín</h1>
            <p class="subtitle">Velas Navideñas Personalizadas</p>
        </header>
        
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="order">Realiza tu Pedido</div>
            <div class="nav-tab" data-tab="prices">Precios</div>
            <div class="nav-tab" data-tab="history">Historial</div>
        </div>

        <!-- Modal Detalles -->
        <div id="orderDetailsModal" class="hidden" style="position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:9999;display:none;">
            <div style="background:#fff;border-radius:8px;max-width:860px;width:95%;padding:20px;position:relative;">
                <button onclick="closeOrderModal()" style="position:absolute;right:12px;top:12px;background:transparent;border:none;font-size:18px;cursor:pointer;color:#333">✕</button>
                <h3 style="margin-top:0;color:var(--primary);">Detalle del Pedido</h3>
                <div id="orderDetailsContent" style="max-height:60vh;overflow:auto;padding-top:8px;color:#333"></div>
                <div style="text-align:right;margin-top:12px;"></div>
            </div>
        </div>
        <!-- Toast container -->
        <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>

        <!-- Confirmación global -->
        <div id="confirmModal">
            <div>
                <div id="confirmModalMessage" style="color:#333;margin-bottom:12px;"></div>
                <div style="text-align:right;">
                    <button id="confirmCancelBtn" class="btn btn-xs" style="margin-right:8px;">No</button>
                    <button id="confirmOkBtn" class="btn btn-xs btn-success">Sí</button>
                </div>
            </div>
        </div>
        
        <!-- Pestaña Realiza tu Pedido -->
        <div id="order-tab" class="tab-content active">
            <div class="row">
                <div class="col">
                    <div class="card">
                        <h2 class="card-title">Información del Cliente</h2>
                        
                        <div class="form-group">
                            <label for="customerName">Nombre de quien realiza el pedido:</label>
                            <input type="text" id="customerName" placeholder="Ingrese su nombre completo">
                        </div>
                        
                        <div class="form-group">
                            <label for="customerPhone">Teléfono de contacto:</label>
                            <input type="tel" id="customerPhone" placeholder="Ingrese su número de teléfono">
                        </div>
                        
                        <div class="form-group">
                            <label for="deliveryDate">Fecha de entrega deseada:</label>
                            <input type="date" id="deliveryDate" min="">
                            <small class="date-hint">Formato: dd/mm/aaaa</small>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2 class="card-title">Productos del Pedido</h2>
                        
                        <div class="products-section">
                            <div id="productsContainer">
                                <!-- Los productos se agregarán aquí dinámicamente -->
                            </div>
                            
                            <button class="add-product-btn" id="addProductBtn">
                                <i class="fas fa-plus"></i>
                                Agregar otro producto
                            </button>
                        </div>
                        
                        <div class="wood-bases-section">
                            <div class="wood-bases-header">
                                <input type="checkbox" id="addWoodBases" onchange="toggleWoodBases()">
                                <label for="addWoodBases">Bases de Madera Personalizadas</label>
                            </div>
                            
                            <div id="woodBasesContainer" class="hidden">
                                <div class="wood-bases-content">
                                    <div class="wood-bases-grid">
                                        <div class="wood-base-price">
                                            <span class="price">$12.000</span>
                                            <span class="label">cada base</span>
                                        </div>
                                        <div class="wood-base-fields">
                                            <div class="wood-base-quantity">
                                                <label for="woodBasesQuantity">Cantidad:</label>
                                                <input type="number" id="woodBasesQuantity" min="1" value="1" class="quantity-input" onchange="updateOrderSummary()">
                                            </div>
                                            <div class="form-group">
                                                <label for="woodBaseMessage">Mensaje para personalizar (opcional):</label>
                                                <textarea id="woodBaseMessage" rows="3" placeholder="Escriba el mensaje que desea en las bases de madera..." onchange="updateOrderSummary()"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2 class="card-title">Personalización de Velas</h2>
                        <p>Ingrese hasta 10 nombres o palabras para personalizar las velas (una por línea) o deje vacío si desea las palabras predeterminadas:</p>
                        <div class="form-group">
                            <textarea id="candlePersonalization" rows="6" placeholder="Escriba cada nombre o palabra en una línea diferente..." oninput="countLines(this)"></textarea>
                            <div id="lineCounter" class="line-counter">Líneas: 0/10</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2 class="card-title">Resumen del Pedido</h2>
                        <div id="orderSummary">
                            <p style="color: #666; font-style: italic;">Agregue productos para ver el resumen</p>
                        </div>
                    </div>
                    
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p>Guardando pedido...</p>
                    </div>
                    
                    <div style="display:flex; gap:10px;">
                        <button id="confirmOrderBtn" class="btn btn-success" style="flex:1;">
                            <i class="fas fa-check"></i>
                            <span>Confirmar Pedido</span>
                        </button>
                        <button id="cancelEditBtn" class="btn btn-danger hidden" style="flex:0 0 auto;">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pestaña Precios -->
        <div id="prices-tab" class="tab-content">
            <div class="card">
                <h2 class="card-title">Nuestras Velas</h2>
                
                <div class="candle-gallery">
                    <div class="candle-gallery-item">
                        <img src="images/Blancas.jpeg" alt="Velas Blancas" class="candle-gallery-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDE1MCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTIwIiByeD0iOCIgZmlsbD0iI2ZmZmZmZiIvPgo8cGF0aCBkPSJNNzUgNjBINjVWNzBINzVWODBINjVWNzBINjVWNjBaTTg1IDYwSDk1VjcwSDg1VjgwSDc1VjcwSDg1VjYwWk03NSA5MEg4NVYxMDBINzVWOTBaTTY1IDkwSDc1VjEwMEg2NVY5MFoiIGZpbGw9IiNkZGRkZGQiLz4KPC9zdmc+'">
                        <div class="candle-gallery-label">Blancas</div>
                    </div>
                    <div class="candle-gallery-item">
                        <img src="images/Mirellas.jpeg" alt="Velas Mirellas" class="candle-gallery-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDE1MCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTIwIiByeD0iOCIgZmlsbD0iI2ZmZmZmZiIvPgo8cGF0aCBkPSJNNzUgNjBINjVWNzBINzVWODBINjVWNzBINjVWNjBaTTg1IDYwSDk1VjcwSDg1VjgwSDc1VjcwSDg1VjYwWk03NSA5MEg4NVYxMDBINzVWOTBaTTY1IDkwSDc1VjEwMEg2NVY5MFoiIGZpbGw9IiNkZGRkZGQiLz4KPC9zdmc+'">
                        <div class="candle-gallery-label">Mirellas</div>
                    </div>
                    <div class="candle-gallery-item">
                        <img src="images/Pesebre.jpeg" alt="Velas Pesebre" class="candle-gallery-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDE1MCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTIwIiByeD0iOCIgZmlsbD0iI2ZmZmZmZiIvPgo8cGF0aCBkPSJNNzUgNjBINjVWNzBINzVWODBINjVWNzBINjVWNjBaTTg1IDYwSDk1VjcwSDg1VjgwSDc1VjcwSDg1VjYwWk03NSA5MEg4NVYxMDBINzVWOTBaTTY1IDkwSDc1VjEwMEg2NVY5MFoiIGZpbGw9IiNkZGRkZGQiLz4KPC9zdmc+'">
                        <div class="candle-gallery-label">Pesebre</div>
                    </div>
                    <div class="candle-gallery-item">
                        <img src="images/Colores.jpeg" alt="Velas Colores" class="candle-gallery-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDE1MCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iMTIwIiByeD0iOCIgZmlsbD0iI2ZmZmZmZiIvPgo8cGF0aCBkPSJNNzUgNjBINjVWNzBINzVWODBINjVWNzBINjVWNjBaTTg1IDYwSDk1VjcwSDg1VjgwSDc1VjcwSDg1VjYwWk03NSA5MEg4NVYxMDBINzVWOTBaTTY1IDkwSDc1VjEwMEg2NVY5MFoiIGZpbGw9IiNkZGRkZGQiLz4KPC9zdmc+'">
                        <div class="candle-gallery-label">Colores</div>
                    </div>
                </div>
                
                <h2 class="card-title">Precios de Referencia</h2>
                
                <table class="unified-price-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Precio</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="price-section">
                            <td colspan="2">Caja</td>
                        </tr>
                        <tr>
                            <td>Blancas</td>
                            <td class="price">$20.000</td>
                        </tr>
                        <tr>
                            <td>Mirellas</td>
                            <td class="price">$22.000</td>
                        </tr>
                        <tr>
                            <td>Pesebre</td>
                            <td class="price">$20.000</td>
                        </tr>
                        <tr>
                            <td>Colores</td>
                            <td class="price">$23.000</td>
                        </tr>
                        
                        <tr class="price-section">
                            <td colspan="2">Bolsa</td>
                        </tr>
                        <tr>
                            <td>Blancas</td>
                            <td class="price">$18.000</td>
                        </tr>
                        <tr>
                            <td>Mirellas</td>
                            <td class="price">$20.000</td>
                        <tr>
                            <td>Pesebre</td>
                            <td class="price">$18.000</td>
                        </tr>
                        <tr>
                            <td>Colores</td>
                            <td class="price">$22.000</td>
                        </tr>
                        
                        <tr class="price-section">
                            <td colspan="2">Accesorios</td>
                        </tr>
                        <tr>
                            <td>Base en Madera</td>
                            <td class="price">$12.000</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Pestaña Historial -->
        <div id="history-tab" class="tab-content">
            <div class="card">
                <h2 class="card-title">Historial de Pedidos</h2>
                
                <div class="excel-buttons">
                    <button id="exportExcelBtn" class="btn btn-success">
                        <i class="fas fa-file-excel"></i>
                        Exportar a Excel
                    </button>
                    <button id="importExcelBtn" class="btn btn-info">
                        <i class="fas fa-file-import"></i>
                        Importar desde Excel
                    </button>
                    <input type="file" id="fileInput" accept=".xlsx, .xls">
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px;">
                    <div style="color:#666; font-size:0.95rem;">Pedidos guardados localmente en su navegador.</div>
                </div>
                <div class="filters-row" style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
                    <select id="stateFilterSelect" class="state-filter">
                        <option value="">Todos los estados</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Entregado">Entregado</option>
                    </select>
                    <input id="searchClientInput" class="client-search" type="text" placeholder="Buscar por cliente..." />
                    <button id="clearFiltersBtn" class="btn btn-xs" style="padding:8px 10px;">Limpiar</button>
                </div>
                <div style="overflow:auto;">
                    <table class="unified-price-table" style="width:100%;">
                        <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Cliente</th>
                                        <th>Fecha Entrega</th>
                                        <th>Productos</th>
                                        <th>Total</th>
                                        <th>Acciones</th>
                                    </tr>
                        </thead>
                        <tbody id="ordersHistoryBody">
                            <tr><td colspan="6" style="color:#666; text-align:center;">No hay pedidos guardados.</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="paginationControls" style="margin-top:10px;display:flex;gap:8px;align-items:center;justify-content:center;"></div>
                
                <!-- Totales del historial -->
                <div id="historyTotals" class="history-totals">
                    <div class="total-item">
                        <div class="total-value" id="totalCajas">0</div>
                        <div class="total-label">Total Cajas</div>
                    </div>
                    <div class="total-item">
                        <div class="total-value" id="totalBolsas">0</div>
                        <div class="total-label">Total Bolsas</div>
                    </div>
                    <div class="total-item">
                        <div class="total-value" id="totalDinero">$0</div>
                        <div class="total-label">Total en Dinero</div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2025 Gestor de Pedidos - Detalles Laurel Medellín - Velas Navideñas</p>
        </footer>
    </div>

    <script>
        // Local storage key for orders history
        const STORAGE_KEY = 'ordersHistory';

        // Precios de referencia
        const prices = {
            Caja: {
                Blancas: 20000,
                Mirellas: 22000,
                Pesebre: 20000,
                Colores: 23000
            },
            Bolsa: {
                Blancas: 18000,
                Mirellas: 20000,
                Pesebre: 18000,
                Colores: 22000
            },
            woodBase: 12000
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Elementos del DOM
            const customerNameInput = document.getElementById('customerName');
            const customerPhoneInput = document.getElementById('customerPhone');
            const deliveryDateInput = document.getElementById('deliveryDate');
            const candlePersonalization = document.getElementById('candlePersonalization');
            const confirmOrderBtn = document.getElementById('confirmOrderBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const loadingDiv = document.getElementById('loading');
            const productsContainer = document.getElementById('productsContainer');
            const searchClientInput = document.getElementById('searchClientInput');
            const stateFilterSelect = document.getElementById('stateFilterSelect');
            const paginationControls = document.getElementById('paginationControls');
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            const orderModalEl = document.getElementById('orderDetailsModal');
            const addProductBtn = document.getElementById('addProductBtn');
            const addWoodBasesCheckbox = document.getElementById('addWoodBases');
            const woodBasesContainer = document.getElementById('woodBasesContainer');
            const woodBasesQuantityInput = document.getElementById('woodBasesQuantity');
            const woodBaseMessageInput = document.getElementById('woodBaseMessage');
            const orderSummaryDiv = document.getElementById('orderSummary');
            const lineCounter = document.getElementById('lineCounter');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const importExcelBtn = document.getElementById('importExcelBtn');
            const fileInput = document.getElementById('fileInput');
            const totalCajasEl = document.getElementById('totalCajas');
            const totalBolsasEl = document.getElementById('totalBolsas');
            const totalDineroEl = document.getElementById('totalDinero');
            
            let productCount = 0;
            let editingOrderId = null;
            const PAGE_SIZE = 15;
            let currentPage = 1;
            
            // Configurar fecha mínima como hoy
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const minDate = tomorrow.toISOString().split('T')[0];
            deliveryDateInput.min = minDate;
            
            // Navegación entre pestañas
            const navTabs = document.querySelectorAll('.nav-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            navTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Actualizar pestañas activas
                    navTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Mostrar contenido correspondiente
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // Agregar producto
            addProductBtn.addEventListener('click', function() {
                addProductItem();
            });
            
            // Agregar primer producto por defecto
            addProductItem();

            // Renderizar historial al cargar
            renderOrderHistory();

            // Manejar cierre al hacer click en el backdrop
            if (orderModalEl) {
                orderModalEl.addEventListener('click', function(e) {
                    if (e.target === orderModalEl) {
                        closeOrderModal();
                    }
                });
            }

            // Funciones de notificaciones (toasts) y confirmación
            window.showToast = function(message, type = 'info', duration = 2200) {
                const container = document.getElementById('toastContainer');
                if (!container) return alert(message);
                const toast = document.createElement('div');
                toast.className = 'toast ' + (type || 'info');
                toast.innerHTML = message;
                container.appendChild(toast);
                // show animation
                setTimeout(() => toast.classList.add('show'), 10);
                // hide after duration (if duration <=0, do not auto hide)
                if (duration > 0) {
                    setTimeout(() => {
                        toast.classList.remove('show');
                        setTimeout(() => { try{ container.removeChild(toast); } catch(e){} }, 220);
                    }, duration);
                }
                // click to dismiss
                toast.addEventListener('click', function() {
                    toast.classList.remove('show');
                    setTimeout(() => { try{ container.removeChild(toast); } catch(e){} }, 220);
                });
            };

            // Render pagination controls helper
            function renderPaginationControls(totalPages, current, totalItems) {
                if (!paginationControls) return;
                let html = '';
                // Prev
                html += `<button class="pagination-btn" data-action="prev">&larr;</button>`;

                // Page numbers (show window)
                const maxButtons = 7;
                let start = Math.max(1, current - Math.floor(maxButtons/2));
                let end = Math.min(totalPages, start + maxButtons - 1);
                if (end - start < maxButtons - 1) {
                    start = Math.max(1, end - maxButtons + 1);
                }
                for (let p = start; p <= end; p++) {
                    const cls = p === current ? 'pagination-btn active' : 'pagination-btn';
                    html += `<button class="${cls}" data-page="${p}">${p}</button>`;
                }

                // Next
                html += `<button class="pagination-btn" data-action="next">&rarr;</button>`;
                html += `<span class="pagination-info">Mostrando ${Math.min((current-1)*PAGE_SIZE+1, totalItems)}-${Math.min(current*PAGE_SIZE, totalItems)} de ${totalItems}</span>`;
                paginationControls.innerHTML = html;

                // Attach handlers
                const buttons = paginationControls.querySelectorAll('button.pagination-btn');
                buttons.forEach(b => {
                    const act = b.getAttribute('data-action');
                    const p = b.getAttribute('data-page');
                    b.addEventListener('click', function() {
                        if (act === 'prev') {
                            if (currentPage > 1) currentPage--;
                        } else if (act === 'next') {
                            if (currentPage < totalPages) currentPage++;
                        } else if (p) {
                            currentPage = parseInt(p);
                        }
                        renderOrderHistory();
                    });
                });
            }

            window.showConfirm = function(message, onConfirm, onCancel) {
                const modal = document.getElementById('confirmModal');
                const msg = document.getElementById('confirmModalMessage');
                const okBtn = document.getElementById('confirmOkBtn');
                const cancelBtn = document.getElementById('confirmCancelBtn');
                if (!modal || !msg || !okBtn || !cancelBtn) {
                    // fallback to native confirm
                    if (confirm(message)) { if (onConfirm) onConfirm(); } else { if (onCancel) onCancel(); }
                    return;
                }
                msg.textContent = message;
                modal.style.display = 'flex';
                const cleanup = function() {
                    modal.style.display = 'none';
                    okBtn.onclick = null; cancelBtn.onclick = null;
                };
                okBtn.onclick = function() { cleanup(); if (onConfirm) onConfirm(); };
                cancelBtn.onclick = function() { cleanup(); if (onCancel) onCancel(); };
                // click on backdrop cancels
                const backdropHandler = function(e) { if (e.target === modal) { cleanup(); if (onCancel) onCancel(); modal.removeEventListener('click', backdropHandler); } };
                modal.addEventListener('click', backdropHandler);
            };

            // Buscar / filtrar
            if (searchClientInput) searchClientInput.addEventListener('input', function(){ currentPage = 1; renderOrderHistory(); });
            if (stateFilterSelect) stateFilterSelect.addEventListener('change', function(){ currentPage = 1; renderOrderHistory(); });
            if (clearFiltersBtn) clearFiltersBtn.addEventListener('click', function() {
                if (searchClientInput) searchClientInput.value = '';
                if (stateFilterSelect) stateFilterSelect.value = '';
                currentPage = 1;
                renderOrderHistory();
            });
            
            // Exportar a Excel
            if (exportExcelBtn) {
                exportExcelBtn.addEventListener('click', function() {
                    exportToExcel();
                });
            }
            
            // Importar desde Excel
            if (importExcelBtn) {
                importExcelBtn.addEventListener('click', function() {
                    fileInput.click();
                });
            }
            
            // Manejar selección de archivo
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        importFromExcel(file);
                    }
                    // Resetear el input para permitir seleccionar el mismo archivo otra vez
                    fileInput.value = '';
                });
            }
            
            // Función para exportar a Excel
            function exportToExcel() {
                try {
                    const orders = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                    if (!orders || orders.length === 0) {
                        showToast('No hay datos para exportar.', 'warning');
                        return;
                    }
                    
                    // Preparar datos para Excel
                    const data = [];
                    
                    // Encabezados
                    data.push([
                        'ID', 'Cliente', 'Teléfono', 'Fecha Entrega', 'Fecha Realización', 
                        'Productos', 'Bases Madera', 'Mensaje Base', 'Personalización Velas', 
                        'Total', 'Estado'
                    ]);
                    
                    // Datos
                    orders.forEach(order => {
                        data.push([
                            order.id || '',
                            order.nombreCliente || '',
                            order.telefonoCliente || '',
                            order.fechaEntrega || '',
                            order.fechaRealizacion || '',
                            order.productos || '',
                            order.basesMadera || '',
                            order.mensajeBaseMadera || '',
                            order.personalizacionVelas || '',
                            order.total || '',
                            order.status || 'Pendiente'
                        ]);
                    });
                    
                    // Crear libro de trabajo
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Pedidos');
                    
                    // Generar archivo y descargar
                    const fileName = `pedidos_velas_${new Date().toISOString().slice(0,10)}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    
                    showToast('Datos exportados exitosamente a Excel.', 'success');
                } catch (error) {
                    console.error('Error al exportar a Excel:', error);
                    showToast('Error al exportar a Excel.', 'error');
                }
            }
            
            // Función para importar desde Excel
            function importFromExcel(file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        // Obtener la primera hoja
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        
                        // Verificar que tenga datos
                        if (jsonData.length <= 1) {
                            showToast('El archivo no contiene datos válidos.', 'error');
                            return;
                        }
                        
                        // Obtener encabezados
                        const headers = jsonData[0];
                        
                        // Verificar estructura básica
                        if (!headers.includes('Cliente') || !headers.includes('Productos') || !headers.includes('Total')) {
                            showToast('El archivo no tiene el formato correcto.', 'error');
                            return;
                        }
                        
                        // Procesar datos
                        const orders = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row.length === 0) continue;
                            
                            const order = {
                                id: row[headers.indexOf('ID')] || generateId(),
                                nombreCliente: row[headers.indexOf('Cliente')] || '',
                                telefonoCliente: row[headers.indexOf('Teléfono')] || '',
                                fechaEntrega: row[headers.indexOf('Fecha Entrega')] || '',
                                fechaRealizacion: row[headers.indexOf('Fecha Realización')] || new Date().toLocaleString('es-ES'),
                                productos: row[headers.indexOf('Productos')] || '',
                                basesMadera: row[headers.indexOf('Bases Madera')] || 'No',
                                mensajeBaseMadera: row[headers.indexOf('Mensaje Base')] || 'No aplica',
                                personalizacionVelas: row[headers.indexOf('Personalización Velas')] || 'Palabras predeterminadas',
                                total: row[headers.indexOf('Total')] || 0,
                                status: row[headers.indexOf('Estado')] || 'Pendiente'
                            };
                            
                            orders.push(order);
                        }
                        
                        if (orders.length === 0) {
                            showToast('No se encontraron pedidos válidos en el archivo.', 'warning');
                            return;
                        }
                        
                        // Confirmar importación
                        showConfirm(
                            `¿Importar ${orders.length} pedido(s) desde el archivo? Los pedidos existentes se mantendrán.`,
                            function() {
                                // Combinar con datos existentes
                                const existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                                const combined = [...existing];
                                
                                // Agregar nuevos pedidos, evitando duplicados por ID
                                orders.forEach(newOrder => {
                                    const existingIndex = combined.findIndex(o => o.id === newOrder.id);
                                    if (existingIndex >= 0) {
                                        combined[existingIndex] = newOrder;
                                    } else {
                                        combined.push(newOrder);
                                    }
                                });
                                
                                // Guardar en localStorage
                                localStorage.setItem(STORAGE_KEY, JSON.stringify(combined));
                                renderOrderHistory();
                                showToast(`${orders.length} pedido(s) importados exitosamente.`, 'success');
                            },
                            function() {
                                // Cancelar
                                showToast('Importación cancelada.', 'info');
                            }
                        );
                        
                    } catch (error) {
                        console.error('Error al importar desde Excel:', error);
                        showToast('Error al importar desde Excel. Verifique el formato del archivo.', 'error');
                    }
                };
                
                reader.onerror = function() {
                    showToast('Error al leer el archivo.', 'error');
                };
                
                reader.readAsArrayBuffer(file);
            }
            
            // Confirmar pedido (crear o actualizar)
            confirmOrderBtn.addEventListener('click', async function() {
                const customerName = customerNameInput.value;
                const customerPhone = customerPhoneInput.value;
                const deliveryDate = deliveryDateInput.value;
                const personalizations = candlePersonalization.value.trim();
                
                // Validaciones
                if (!customerName) {
                    showToast('Por favor, ingrese su nombre.', 'error');
                    return;
                }
                
                // El número de teléfono no es obligatorio
                
                if (!deliveryDate) {
                    showToast('Por favor, seleccione una fecha de entrega.', 'error');
                    return;
                }
                
                const products = getProductsData();
                if (products.length === 0) {
                    showToast('Por favor, agregue al menos un producto al pedido.', 'error');
                    return;
                }
                
                // Validar líneas de personalización
                const lines = personalizations.split('\n').filter(line => line.trim() !== '');
                if (lines.length > 10) {
                    showToast('Por favor, ingrese máximo 10 nombres o palabras para personalizar las velas.', 'error');
                    return;
                }
                
                // Procesar personalización - si está vacío, usar "Palabras predeterminadas"
                const personalizacionFinal = personalizations ? lines.join(' | ') : 'Palabras predeterminadas';
                
                // Determinar estado del pedido: conservar si estamos editando
                let status = 'Pendiente';
                if (editingOrderId) {
                    try {
                        const existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                        const eo = existing.find(x => x.id === editingOrderId);
                        if (eo && eo.status) status = eo.status;
                    } catch (e) {
                        // noop
                    }
                }

                // Crear objeto de pedido
                const order = {
                    id: editingOrderId || generateId(),
                    nombreCliente: customerName,
                    telefonoCliente: customerPhone,
                    productos: JSON.stringify(products),
                    personalizacionVelas: personalizacionFinal,
                    fechaRealizacion: new Date().toLocaleString('es-ES'),
                    fechaEntrega: deliveryDate,
                    total: calculateTotal(),
                    status: status
                };
                
                // Agregar bases de madera si están seleccionadas
                if (addWoodBasesCheckbox.checked) {
                    order.basesMadera = 'Sí (' + woodBasesQuantityInput.value + ' unidades)';
                    // Normalizar mensajes para la base: convertir líneas en ' | ' igual que las personalizaciones
                    const rawMsg = (woodBaseMessageInput.value || '').trim();
                    const msgLines = rawMsg.split('\n').map(l => l.trim()).filter(l => l !== '');
                    order.mensajeBaseMadera = msgLines.length > 0 ? msgLines.join(' | ') : 'No aplica';
                } else {
                    order.basesMadera = 'No';
                    order.mensajeBaseMadera = 'No aplica';
                }
                
                // Mostrar loading
                loadingDiv.style.display = 'block';
                confirmOrderBtn.disabled = true;
                
                try {
                    if (editingOrderId) {
                        updateOrderLocal(order);
                        showToast('Pedido actualizado correctamente.', 'success', 2200);
                    } else {
                        saveOrderToLocal(order);
                        const formattedDate = new Date(deliveryDate).toLocaleDateString('es-ES');
                        showToast(`<strong>¡Pedido confirmado con éxito!</strong><br>Cliente: ${customerName}<br>Teléfono: ${customerPhone || 'No proporcionado'}<br>Fecha de entrega: ${formattedDate}<br>Total: $${calculateTotal().toLocaleString()}<br><small>Los datos han sido guardados en el Historial de Pedidos.</small>`, 'success', 3000);
                    }

                    // Limpiar formulario y resetear modo edición
                    resetForm();

                } catch (error) {
                    console.error('Error al guardar el pedido localmente:', error);
                    showToast('Error al guardar el pedido. Por favor, intente nuevamente.', 'error');
                } finally {
                    // Ocultar loading
                    loadingDiv.style.display = 'none';
                    confirmOrderBtn.disabled = false;
                    cancelEditBtn.classList.add('hidden');
                    editingOrderId = null;
                    confirmOrderBtn.innerHTML = '<i class="fas fa-check"></i> <span>Confirmar Pedido</span>';
                }
            });

            // Cancelar edición
            cancelEditBtn.addEventListener('click', function() {
                showConfirm('Cancelar edición del pedido?', function() {
                    editingOrderId = null;
                    resetForm();
                    cancelEditBtn.classList.add('hidden');
                    confirmOrderBtn.innerHTML = '<i class="fas fa-check"></i> <span>Confirmar Pedido</span>';
                }, function() {
                    // cancel, do nothing
                });
            });
            
            // Función para contar líneas
            window.countLines = function(textarea) {
                const lines = textarea.value.split('\n').filter(line => line.trim() !== '');
                const lineCount = lines.length;
                
                lineCounter.textContent = `Líneas: ${lineCount}/10`;
                
                // Cambiar color según el número de líneas
                lineCounter.className = 'line-counter';
                if (lineCount >= 8 && lineCount <= 10) {
                    lineCounter.classList.add('warning');
                } else if (lineCount > 10) {
                    lineCounter.classList.add('error');
                }
            };
            
            // Función para agregar producto
            function addProductItem() {
                productCount++;
                const productId = Date.now();
                const productHtml = `
                    <div class="product-item" data-id="${productId}">
                        <div class="product-header">
                            <div class="product-number">Producto ${productCount}</div>
                            <button class="remove-product" onclick="removeProduct(${productId})" title="Eliminar producto">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="product-fields">
                            <div class="form-group">
                                <label>Tipo de Empaque:</label>
                                <select class="packaging-select" onchange="updateOrderSummary()">
                                    <option value="">Seleccione empaque</option>
                                    <option value="Caja">Caja</option>
                                    <option value="Bolsa">Bolsa</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tipo de Vela:</label>
                                <select class="candle-type-select" onchange="updateOrderSummary()">
                                    <option value="">Seleccione vela</option>
                                    <option value="Blancas">Blancas</option>
                                    <option value="Mirellas">Mirellas</option>
                                    <option value="Pesebre">Pesebre</option>
                                    <option value="Colores">Colores</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Cantidad:</label>
                                <input type="number" class="quantity-input" min="1" value="1" onchange="updateOrderSummary()">
                            </div>
                        </div>
                    </div>
                `;
                productsContainer.insertAdjacentHTML('beforeend', productHtml);
                updateOrderSummary();
            }
            
            // Función para obtener datos de productos
            function getProductsData() {
                const products = [];
                const productItems = productsContainer.querySelectorAll('.product-item');
                
                productItems.forEach(item => {
                    const packaging = item.querySelector('.packaging-select').value;
                    const candleType = item.querySelector('.candle-type-select').value;
                    const quantity = parseInt(item.querySelector('.quantity-input').value);
                    
                    if (packaging && candleType && quantity > 0) {
                        products.push({
                            packaging: packaging,
                            candleType: candleType,
                            quantity: quantity,
                            unitPrice: prices[packaging][candleType],
                            subtotal: prices[packaging][candleType] * quantity
                        });
                    }
                });
                
                return products;
            }
            
            // Función para calcular total
            function calculateTotal() {
                let total = 0;
                
                // Sumar productos
                const products = getProductsData();
                products.forEach(product => {
                    total += product.subtotal;
                });
                
                // Sumar bases de madera si están seleccionadas
                if (addWoodBasesCheckbox.checked) {
                    const woodBasesQuantity = parseInt(woodBasesQuantityInput.value) || 0;
                    total += woodBasesQuantity * prices.woodBase;
                }
                
                return total;
            }
            
            // Función para actualizar resumen
            function updateOrderSummary() {
                const products = getProductsData();
                let summaryHtml = '';
                
                if (products.length === 0) {
                    summaryHtml = '<p style="color: #666; font-style: italic;">Agregue productos para ver el resumen</p>';
                } else {
                    summaryHtml = '<div class="summary-items">';
                    
                    // Productos
                    products.forEach((product, index) => {
                        const displayPackaging = product.quantity > 1 ? 
                            `${product.packaging} x${product.quantity}` : 
                            product.packaging;
                            
                        summaryHtml += `
                            <div class="summary-item">
                                <span>${displayPackaging.toLowerCase()} de ${product.candleType.toLowerCase()}</span>
                                <span class="price">$${product.subtotal.toLocaleString()}</span>
                            </div>
                        `;
                    });
                    
                    // Bases de madera
                    if (addWoodBasesCheckbox.checked) {
                        const woodBasesQuantity = parseInt(woodBasesQuantityInput.value) || 0;
                        const woodBasesSubtotal = woodBasesQuantity * prices.woodBase;
                        summaryHtml += `
                            <div class="summary-item">
                                <span>${woodBasesQuantity} base(s) de madera</span>
                                <span class="price">$${woodBasesSubtotal.toLocaleString()}</span>
                            </div>
                        `;
                    }
                    
                    // Total
                    const total = calculateTotal();
                    summaryHtml += `
                        <div class="summary-total">
                            <span>TOTAL:</span>
                            <span class="price">$${total.toLocaleString()}</span>
                        </div>
                    `;
                    
                    summaryHtml += '</div>';
                }
                
                orderSummaryDiv.innerHTML = summaryHtml;
            }
            
            // Guardar pedido en localStorage
            function saveOrderToLocal(orderData) {
                const existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                // Si ya existe con el mismo id, reemplazarlo
                const idx = existing.findIndex(e => e.id && orderData.id && e.id === orderData.id);
                if (idx > -1) {
                    existing[idx] = orderData;
                } else {
                    // Añadir al inicio para que el más reciente aparezca primero
                    existing.unshift(orderData);
                }
                localStorage.setItem(STORAGE_KEY, JSON.stringify(existing));
                renderOrderHistory();
            }

            // Actualizar pedido existente en localStorage
            function updateOrderLocal(orderData) {
                const existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                const idx = existing.findIndex(e => e.id && orderData.id && e.id === orderData.id);
                if (idx > -1) {
                    existing[idx] = orderData;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(existing));
                    renderOrderHistory();
                } else {
                    // Si no existe, añadirlo
                    saveOrderToLocal(orderData);
                }
            }

            // Generar id simple
            function generateId() {
                return Date.now().toString(36) + '-' + Math.random().toString(36).substr(2,6);
            }

            // Calcular totales del historial
            function calculateHistoryTotals(orders) {
                let totalCajas = 0;
                let totalBolsas = 0;
                let totalDinero = 0;
                
                orders.forEach(order => {
                    // Sumar total en dinero
                    totalDinero += parseInt(order.total) || 0;
                    
                    // Contar cajas y bolsas
                    try {
                        const productos = JSON.parse(order.productos);
                        productos.forEach(producto => {
                            if (producto.packaging === 'Caja') {
                                totalCajas += producto.quantity || 0;
                            } else if (producto.packaging === 'Bolsa') {
                                totalBolsas += producto.quantity || 0;
                            }
                        });
                    } catch (e) {
                        // Si hay error al parsear, intentar contar manualmente
                        const productosStr = order.productos || '';
                        if (productosStr.includes('Caja')) {
                            const match = productosStr.match(/Caja.*x(\d+)/);
                            if (match) totalCajas += parseInt(match[1]) || 1;
                        }
                        if (productosStr.includes('Bolsa')) {
                            const match = productosStr.match(/Bolsa.*x(\d+)/);
                            if (match) totalBolsas += parseInt(match[1]) || 1;
                        }
                    }
                });
                
                return { totalCajas, totalBolsas, totalDinero };
            }

            // Renderizar historial de pedidos
            function renderOrderHistory() {
                const tbody = document.getElementById('ordersHistoryBody');
                if (!tbody) return;
                let orders = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]') || [];
                // Normalizar pedidos antiguos: si falta 'id', agregar uno.
                let needsSave = false;
                orders = orders.map(o => {
                    if (!o.id) {
                        o.id = generateId();
                        needsSave = true;
                    }
                    return o;
                });
                if (needsSave) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(orders));
                }
                // Obtener filtros
                const nameFilter = (document.getElementById('searchClientInput') && document.getElementById('searchClientInput').value || '').trim().toLowerCase();
                const stateFilter = (document.getElementById('stateFilterSelect') && document.getElementById('stateFilterSelect').value) || '';

                if (!orders || orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="color:#666; text-align:center;">No hay pedidos guardados.</td></tr>';
                    if (paginationControls) paginationControls.innerHTML = '';
                    
                    // Actualizar totales
                    totalCajasEl.textContent = '0';
                    totalBolsasEl.textContent = '0';
                    totalDineroEl.textContent = '$0';
                    
                    return;
                }

                // Aplicar filtros (por nombre y/o estado)
                const filtered = orders.filter(o => {
                    if (nameFilter && !(o.nombreCliente||'').toLowerCase().includes(nameFilter)) return false;
                    if (stateFilter && ((o.status||'') !== stateFilter)) return false;
                    return true;
                });

                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="color:#666; text-align:center;">No hay resultados para los filtros seleccionados.</td></tr>';
                    if (paginationControls) paginationControls.innerHTML = '';
                    
                    // Actualizar totales
                    totalCajasEl.textContent = '0';
                    totalBolsasEl.textContent = '0';
                    totalDineroEl.textContent = '$0';
                    
                    return;
                }

                // Paginación
                const totalItems = filtered.length;
                const totalPages = Math.max(1, Math.ceil(totalItems / PAGE_SIZE));
                if (currentPage > totalPages) currentPage = 1;
                const startIndex = (currentPage - 1) * PAGE_SIZE;
                const pageItems = filtered.slice(startIndex, startIndex + PAGE_SIZE);

                let html = '';
                pageItems.forEach((o, idx) => {
                    const globalIndex = startIndex + idx; // index in filtered
                    let productosDisplay = '';
                    try {
                        const prods = JSON.parse(o.productos);
                        productosDisplay = prods.map(p => `${p.packaging} ${p.candleType} x${p.quantity}`).join(' — ');
                    } catch (e) {
                        productosDisplay = o.productos;
                    }

                    const totalNum = parseInt(o.total) || 0;
                    const statusLabel = o.status || 'Pendiente';
                    const statusColor = statusLabel.toLowerCase() === 'entregado' ? 'green' : '#666';
                    const rowNumber = (globalIndex + 1);
                    html += `
                        <tr>
                            <td style="width:48px;">${rowNumber}</td>
                            <td>${o.nombreCliente}<br><small style="color:${statusColor};font-weight:600">${statusLabel}</small></td>
                            <td>${o.fechaEntrega}</td>
                            <td>${productosDisplay}</td>
                            <td class="price">$${totalNum.toLocaleString()}</td>
                            <td>
                                <button class="btn btn-info btn-xs" onclick="viewOrderDetails('${o.id}')">Ver</button>
                                <button class="btn btn-warning btn-xs" onclick="editOrder('${o.id}')">Editar</button>
                                <button class="btn btn-danger btn-xs" onclick="deleteOrder('${o.id}')">Borrar</button>
                            </td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;

                // Render pagination controls
                if (paginationControls) {
                    renderPaginationControls(totalPages, currentPage, totalItems);
                }
                
                // Calcular y mostrar totales
                const totals = calculateHistoryTotals(filtered);
                totalCajasEl.textContent = totals.totalCajas;
                totalBolsasEl.textContent = totals.totalBolsas;
                totalDineroEl.textContent = `$${totals.totalDinero.toLocaleString()}`;
            }

            // Borrar historial completo (expuesto globalmente)
            window.clearOrderHistory = function() {
                showConfirm('¿Borrar todo el historial de pedidos? Esta acción no se puede deshacer.', function() {
                    localStorage.removeItem(STORAGE_KEY);
                    renderOrderHistory();
                }, function() {
                    // canceled
                });
            };

            // Borrar un pedido por id
            window.deleteOrder = function(id) {
                showConfirm('¿Borrar este pedido?', function() {
                    const existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                    const filtered = existing.filter(o => o.id !== id);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(filtered));
                    renderOrderHistory();
                }, function() {
                    // canceled
                });
            };

            // Cambiar estado de un pedido
            window.changeOrderStatus = function(id, newStatus) {
                try {
                    const existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                    const idx = existing.findIndex(o => o.id === id);
                    if (idx === -1) {
                        showToast('Pedido no encontrado', 'error');
                        return;
                    }
                    existing[idx].status = newStatus;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(existing));
                    renderOrderHistory();
                    showToast('Estado actualizado: ' + newStatus, 'success', 1800);
                    // Si el modal está abierto con el mismo pedido, actualizar su contenido
                    const modal = document.getElementById('orderDetailsModal');
                    if (modal && modal.style.display !== 'none') {
                        // Re-open details to refresh content
                        viewOrderDetails(id);
                    }
                } catch (e) {
                    console.error('Error al cambiar estado:', e);
                    showToast('No se pudo actualizar el estado', 'error');
                }
            };

            // Ver detalles de un pedido
            window.viewOrderDetails = function(id) {
                const existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                const o = existing.find(x => x.id === id);
                if (!o) { showToast('Pedido no encontrado', 'error'); return; }
                const container = document.getElementById('orderDetailsContent');
                let html = '';
                html += `<p><strong>Cliente:</strong> ${o.nombreCliente}</p>`;
                html += `<p><strong>Teléfono:</strong> ${o.telefonoCliente || 'No proporcionado'}</p>`;
                html += `<p><strong>Fecha de entrega:</strong> ${o.fechaEntrega}</p>`;
                const _statusText = o.status || 'Pendiente';
                const _statusClass = (_statusText.toLowerCase() === 'entregado') ? 'status-entregado' : 'status-pendiente';
                html += `<p><strong>Estado:</strong> <button id="orderStatusBtn" class="status-btn ${_statusClass}" style="margin-left:8px;">${_statusText}</button></p>`;
                html += `<hr>`;
                html += `<h4>Productos</h4>`;
                try {
                    const prods = JSON.parse(o.productos);
                    html += `<ul style="padding-left:18px;">`;
                    prods.forEach(p => {
                        html += `<li><strong>Producto:</strong> ${p.packaging} ${p.candleType} — <strong>Cantidad:</strong> ${p.quantity}</li>`;
                    });
                    html += `</ul>`;
                } catch (e) {
                    html += `<p>${o.productos}</p>`;
                }
                html += `<p><strong>Bases de madera:</strong> ${o.basesMadera || 'No'}</p>`;
                html += `<p><strong>Mensaje para base:</strong> ${o.mensajeBaseMadera || 'No aplica'}</p>`;
                html += `<p><strong>Nombres/Palabras para velas:</strong> ${o.personalizacionVelas || 'Palabras predeterminadas'}</p>`;
                html += `<hr>`;
                html += `<p style="font-weight:700;">Total: <span class="price">$${(parseInt(o.total)||0).toLocaleString()}</span></p>`;
                container.innerHTML = html;
                if (orderModalEl) {
                    orderModalEl.style.display = 'flex';
                } else {
                    document.getElementById('orderDetailsModal').style.display = 'flex';
                }

                // Inicializar botón de estado (click alterna Pendiente <-> Entregado)
                const statusBtn = document.getElementById('orderStatusBtn');
                if (statusBtn) {
                    statusBtn.addEventListener('click', function() {
                        const current = (statusBtn.textContent || '').trim();
                        const newStatus = current === 'Entregado' ? 'Pendiente' : 'Entregado';
                        // Feedback inmediato: actualizar apariencia
                        statusBtn.textContent = newStatus;
                        statusBtn.classList.toggle('status-entregado', newStatus === 'Entregado');
                        statusBtn.classList.toggle('status-pendiente', newStatus === 'Pendiente');
                        changeOrderStatus(id, newStatus);
                    });
                }
            };

            window.closeOrderModal = function() {
                const modal = document.getElementById('orderDetailsModal');
                const content = document.getElementById('orderDetailsContent');
                if (modal) modal.style.display = 'none';
                if (content) content.innerHTML = '';
            };

            // Editar pedido: cargar datos al formulario
            window.editOrder = function(id) {
                const existing = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                const o = existing.find(x => x.id === id);
                if (!o) { showToast('Pedido no encontrado', 'error'); return; }
                // Cargar datos en formulario
                customerNameInput.value = o.nombreCliente || '';
                customerPhoneInput.value = o.telefonoCliente || '';
                deliveryDateInput.value = o.fechaEntrega || '';
                candlePersonalization.value = o.personalizacionVelas && o.personalizacionVelas !== 'Palabras predeterminadas' ? o.personalizacionVelas.split(' | ').join('\n') : '';
                // Productos
                productsContainer.innerHTML = '';
                productCount = 0;
                try {
                    const prods = JSON.parse(o.productos);
                    prods.forEach(p => {
                        productCount++;
                        const productId = Date.now() + Math.floor(Math.random()*1000);
                        const productHtml = `
                            <div class="product-item" data-id="${productId}">
                                <div class="product-header">
                                    <div class="product-number">Producto ${productCount}</div>
                                    <button class="remove-product" onclick="removeProduct(${productId})" title="Eliminar producto">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="product-fields">
                                    <div class="form-group">
                                        <label>Tipo de Empaque:</label>
                                        <select class="packaging-select" onchange="updateOrderSummary()">
                                            <option value="">Seleccione empaque</option>
                                            <option value="Caja" ${p.packaging==='Caja'?'selected':''}>Caja</option>
                                            <option value="Bolsa" ${p.packaging==='Bolsa'?'selected':''}>Bolsa</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Tipo de Vela:</label>
                                        <select class="candle-type-select" onchange="updateOrderSummary()">
                                            <option value="">Seleccione vela</option>
                                            <option value="Blancas" ${p.candleType==='Blancas'?'selected':''}>Blancas</option>
                                            <option value="Mirellas" ${p.candleType==='Mirellas'?'selected':''}>Mirellas</option>
                                            <option value="Pesebre" ${p.candleType==='Pesebre'?'selected':''}>Pesebre</option>
                                            <option value="Colores" ${p.candleType==='Colores'?'selected':''}>Colores</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Cantidad:</label>
                                        <input type="number" class="quantity-input" min="1" value="${p.quantity}" onchange="updateOrderSummary()">
                                    </div>
                                </div>
                            </div>
                        `;
                        productsContainer.insertAdjacentHTML('beforeend', productHtml);
                    });
                } catch (e) {
                    // no-op
                }
                // Bases
                if ((o.basesMadera||'').toLowerCase().includes('sí') || (o.basesMadera||'').toLowerCase().includes('si')) {
                    addWoodBasesCheckbox.checked = true;
                    woodBasesContainer.classList.remove('hidden');
                    // intentar extraer cantidad
                    const m = (o.basesMadera || '').match(/(\d+)/);
                    woodBasesQuantityInput.value = m ? m[0] : '1';
                    // Convertir el formato almacenado (separador ' | ') a líneas en el textarea
                    if (o.mensajeBaseMadera && o.mensajeBaseMadera !== 'No aplica') {
                        woodBaseMessageInput.value = o.mensajeBaseMadera.split(' | ').join('\n');
                    } else {
                        woodBaseMessageInput.value = '';
                    }
                } else {
                    addWoodBasesCheckbox.checked = false;
                    woodBasesContainer.classList.add('hidden');
                }

                updateOrderSummary();
                editingOrderId = id;
                cancelEditBtn.classList.remove('hidden');
                confirmOrderBtn.innerHTML = '<i class="fas fa-save"></i> <span>Guardar cambios</span>';
                // Ir a pestaña de formulario
                navTabs.forEach(t => t.classList.remove('active'));
                document.querySelector('.nav-tab[data-tab="order"]').classList.add('active');
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById('order-tab').classList.add('active');
            };
            
            // Funciones auxiliares
            function resetForm() {
                customerNameInput.value = '';
                customerPhoneInput.value = '';
                deliveryDateInput.value = '';
                candlePersonalization.value = '';
                productsContainer.innerHTML = '';
                productCount = 0;
                addWoodBasesCheckbox.checked = false;
                woodBasesContainer.classList.add('hidden');
                woodBasesQuantityInput.value = '1';
                woodBaseMessageInput.value = '';
                lineCounter.textContent = 'Líneas: 0/10';
                lineCounter.className = 'line-counter';
                addProductItem();
                updateOrderSummary();
            }
            
            // Hacer funciones disponibles globalmente
            window.removeProduct = function(productId) {
                const productElement = document.querySelector(`.product-item[data-id="${productId}"]`);
                if (productElement) {
                    productElement.remove();
                    productCount--;
                    // Renumerar productos restantes
                    const remainingProducts = productsContainer.querySelectorAll('.product-item');
                    remainingProducts.forEach((product, index) => {
                        const numberElement = product.querySelector('.product-number');
                        if (numberElement) {
                            numberElement.textContent = `Producto ${index + 1}`;
                        }
                    });
                    updateOrderSummary();
                }
            };
            
            window.toggleWoodBases = function() {
                if (addWoodBasesCheckbox.checked) {
                    woodBasesContainer.classList.remove('hidden');
                } else {
                    woodBasesContainer.classList.add('hidden');
                }
                updateOrderSummary();
            };
            
            window.updateOrderSummary = updateOrderSummary;
        });
    </script>
</body>
</html>